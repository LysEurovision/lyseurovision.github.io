<script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" integrity="sha512-3j3VU6WC5rPQB4Ld1jnLV7Kd5xr+cq9avvhwqzbH/taCRNURoeEpoPBK9pDyeukwSxwRPJ8fDgvYXd6SkaZ2TA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
    const FLAG_EMOJIS = {
        "Andorra": "\uD83C\uDDE6\uD83C\uDDE9",
        "Albania": "\uD83C\uDDE6\uD83C\uDDF1",
        "Armenia": "\uD83C\uDDE6\uD83C\uDDF2",
        "Austria": "\uD83C\uDDE6\uD83C\uDDF9",
        "Australia": "\uD83C\uDDE6\uD83C\uDDFA",
        "Azerbaijan": " \uD83C\uDDE6\uD83C\uDDFF",
        "Bosnia and Herzegovina": "\uD83C\uDDE7\uD83C\uDDE6",
        "Belgium": "\uD83C\uDDE7\uD83C\uDDEA",
        "Bulgaria": "\uD83C\uDDE7\uD83C\uDDEC",
        "Belarus": "\uD83C\uDDE7\uD83C\uDDFE",
        "Switzerland": "\uD83C\uDDE8\uD83C\uDDED",
        "Cyprus": "\uD83C\uDDE8\uD83C\uDDFE",
        "Czech Republic": "\uD83C\uDDE8\uD83C\uDDFF",
        "Germany": "\uD83C\uDDE9\uD83C\uDDEA",
        "Denmark": "\uD83C\uDDE9\uD83C\uDDF0",
        "Estonia": "\uD83C\uDDEA\uD83C\uDDEA",
        "Spain": "\uD83C\uDDEA\uD83C\uDDF8",
        "Finland": "\uD83C\uDDEB\uD83C\uDDEE",
        "France": "\uD83C\uDDEB\uD83C\uDDF7",
        "United Kingdom": "\uD83C\uDDEC\uD83C\uDDE7",
        "Georgia": "\uD83C\uDDEC\uD83C\uDDEA",
        "Greece": "\uD83C\uDDEC\uD83C\uDDF7",
        "Croatia": "\uD83C\uDDED\uD83C\uDDF7",
        "Hungary": "\uD83C\uDDED\uD83C\uDDFA",
        "Ireland": "\uD83C\uDDEE\uD83C\uDDEA",
        "Israel": "\uD83C\uDDEE\uD83C\uDDF1",
        "Iceland": "\uD83C\uDDEE\uD83C\uDDF8",
        "Italy": "\uD83C\uDDEE\uD83C\uDDF9",
        "Kazakhstan": "\uD83C\uDDF0\uD83C\uDDFF",
        "Lebanon": "\uD83C\uDDF1\uD83C\uDDE7",
        "Liechtenstein": "\uD83C\uDDF1\uD83C\uDDEE",
        "Lithuania": "\uD83C\uDDF1\uD83C\uDDF9",
        "Luxembourg": "\uD83C\uDDF1\uD83C\uDDFA",
        "Latvia": "\uD83C\uDDF1\uD83C\uDDFB",
        "Morocco": "\uD83C\uDDF2\uD83C\uDDE6",
        "Monaco": "\uD83C\uDDF2\uD83C\uDDE8",
        "Moldova": "\uD83C\uDDF2\uD83C\uDDE9",
        "Montenegro": "\uD83C\uDDF2\uD83C\uDDEA",
        "Malta": "\uD83C\uDDF2\uD83C\uDDF9",
        "Netherlands": "\uD83C\uDDF3\uD83C\uDDF1",
        "North Macedonia": "\uD83C\uDDF2\uD83C\uDDF0",
        "Norway": "\uD83C\uDDF3\uD83C\uDDF4",
        "Poland": "\uD83C\uDDF5\uD83C\uDDF1",
        "Portugal": "\uD83C\uDDF5\uD83C\uDDF9",
        "Romania": "\uD83C\uDDF7\uD83C\uDDF4",
        "Serbia": "\uD83C\uDDF7\uD83C\uDDF8",
        "Russia": "\uD83C\uDDF7\uD83C\uDDFA",
        "Sweden": "\uD83C\uDDF8\uD83C\uDDEA",
        "Slovenia": "\uD83C\uDDF8\uD83C\uDDEE",
        "Slovakia": "\uD83C\uDDF8\uD83C\uDDF0",
        "San Marino": "\uD83C\uDDF8\uD83C\uDDF2",
        "Turkey": "\uD83C\uDDF9\uD83C\uDDF7",
        "Ukraine": "\uD83C\uDDFA\uD83C\uDDE6",
        "Kosovo": "\uD83C\uDDFD\uD83C\uDDF0"
    }
    const ONE_DAY = 24 * 60 * 60 * 1000;
    const TODAY = new Date();
    let PAST_EVENTS = [];
    let FUTURE_EVENTS = [];

    function initSettings() {
        if (localStorage.getItem('dark_theme') === undefined) {
            localStorage.setItem('dark_theme', "enabled");
        } else if (localStorage.getItem('dark_theme') == "disabled") {
            $("body").removeClass("dark-mode").addClass("light-mode");
            $("#dark-mode-toggle").prop("checked", false);
        }

        if (localStorage.getItem('display_legend') === undefined) {
            localStorage.setItem('display_legend', "yes");
        } else if (localStorage.getItem('display_legend') == "no") {
            $(".legend ul").css("display", "none");
            $("#legend-toggle").find(".material-icons").html("expand_more");
        }
    }

    function addMonthLabel(month, isFuture) {
        if (isFuture) {
            $("#calendar").append(`<div class="month-label">${month}</div>`);
        } else {
            $("#calendar").prepend(`<div class="month-label">${month}</div>`);
        }
    }

    function addEvent(event, date, isFuture) {
        const isChannelPresent = event['watchLinks'] && event['watchLinks'].length > 0 && 'channel' in event['watchLinks'][0] && event['watchLinks'][0]['channel'] != "";
        const isEventMoreThan7DaysAway = Math.round((date - TODAY) / ONE_DAY) > 7;
        const watchLinks = event['watchLinks']
            .filter(link => isFuture ? link['live'] : link['replayable']) // if the event is in the future, show only the links that can be viewed live; if it's in the past, show only the links that can be viewed on replay
            .sort((l1, l2) => l1['comment'] == 'Recommended link' ? -1 : 1);
        const isGeoblocked = event["watchLinks"].length == 1 && event['watchLinks'][0]['geoblocked'] == true;
        const isAccountRequired = event["watchLinks"].length == 1 && event['watchLinks'][0]['accountRequired'] == true;

        let htmlString = `
            <div class="card ${isFuture ? '' : 'past-event'}">
                <div class="card-container">
                    <div class="date">
                        <div class="date-container">
                            <div class="day">${date.toLocaleString('default', { day: '2-digit' })}</div>
                            <div class="month">${date.toLocaleString('en-GB', { month: 'short' })}</div>
                            ${isEventMoreThan7DaysAway ? '' : '<div class="time">' + date.toLocaleString('en-GB', {hour: '2-digit', minute: '2-digit'}) + '</div><div class="timezone">CET</div>'}
                        </div>
                    </div>
                    <div class="details">
                        <div class="vertical-container">
                            <div class="condensable">
                                <div class="country">${event['country'] in FLAG_EMOJIS ? FLAG_EMOJIS[event['country']] + ' ' : ''}${event['country']}</div>
                                <div class="show-name">${event['name']}</div>
                                <div class="show-stage">${event['stage']}</div>
                                <div class="labels">
                                    ${isChannelPresent ? '<div class="label">' + event['watchLinks'][0]['channel'] + '</div>' : ''}
                                    ${isAccountRequired ? '<div class="label">Account required</div>' : ''}
                                    ${isGeoblocked ? '<div class="label red">Geoblocked</div>' : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    <a href="#!" class="watch-link-action ${watchLinks.length == 0 ? 'no-link' : ''} ${isGeoblocked ? 'geoblocked' : ''}">
                        <i class="material-icons" original-icon="${watchLinks.length > 0 ? 'play_arrow' : 'play_disabled'}">${watchLinks.length > 0 ? 'play_arrow' : 'play_disabled'}</i>
                    </a>
                </div>
                <div class="watch-links-wrapper" style="display: none;">
        `
        watchLinks.forEach((link, i) => {
                const comment = link['comment'] == "Recommended link" ? 'recommended' : link['comment'];
                const geoblocked = link['geoblocked'];
                htmlString += `
                    <div class="watch-link ${geoblocked ? 'geoblocked' : ''}">
                        <a href="${(!link['link'].startsWith('http') ? 'http://' : '') + link['link']}" class="main-link">
                            <span class="title">Link #${i+1} <span class="comment">${!geoblocked && comment ? '(' + comment + ')' : ''}</span></span>
                            <span class="link">${link['link'].replace('https://', '').replace('http://', '').replace('www.', '').split('/', 2)[0]}</span>
                            ${geoblocked ? '<i class="material-icons">public_off</i>' : ''}
                            ${link['accountRequired'] ? '<i class="material-icons">person</i>' : ''}
                            ${link['castable'] ? '<i class="material-icons">cast</i>' : ''}
                            ${link['replayable'] ? '<i class="material-icons">replay</i>' : ''}
                        </a>
                        ${link['accountRequired'] ? '<a href="./help.html#account-' + event['country'] + '" class="create-account-link" style="">Create account</a>' : ''}
                    </div>
                `;
        });

        if (watchLinks.length == 0) {
            htmlString += `
                <div class="watch-link no-link">
                    <span class="title">No watch link available (yet?) :(</span>
                </div>
            `;
        }

        htmlString += `
                </div>
            </div>
        `;
        if (isFuture) {
            $("#calendar").append(htmlString);
        } else {
            $("#calendar").prepend(htmlString);
        }
    }

    function enableWatchLinks(isFuture) {
        const selector = (!isFuture ? '.past-event ' : '') + 'a.watch-link-action';
        $(selector).click(function() {
            const areLinksHidden = $(this).parent().siblings(".watch-links-wrapper").css("display") == "none";
            if (areLinksHidden) {
                $(this).parent().siblings(".watch-links-wrapper").css("display", "block");
                $(this).find(".material-icons").html("expand_less");
            } else {
                $(this).parent().siblings(".watch-links-wrapper").css("display", "none");
                $(this).find(".material-icons").html($(this).find(".material-icons").attr("original-icon"));
            }
        });
    }

    $(function() {
        initSettings();
        $("#dark-mode-toggle").change(function() {
            if ($(this).is(":checked")) {
                $("body").removeClass("light-mode").addClass("dark-mode");
                localStorage.setItem('dark_theme', "enabled");
            } else {
                $("body").removeClass("dark-mode").addClass("light-mode");
                localStorage.setItem('dark_theme', "disabled");
            }
        });

        $("#legend-toggle").click(function() {
            const isLegendHidden = $(this).parent().siblings("ul").css("display") == "none";
            if (isLegendHidden) {
                $(this).parent().siblings("ul").css("display", "block");
                $(this).find(".material-icons").html("expand_less");
                localStorage.setItem('display_legend', "yes");
            } else {
                $(this).parent().siblings("ul").css("display", "none");
                $(this).find(".material-icons").html("expand_more");
                localStorage.setItem('display_legend', "no");
            }
        });

        $.getJSON("https://raw.githubusercontent.com/LysEurovision/lyseurovision.github.io/main/lys_dump.json", function(data, status) {
            PAST_EVENTS = data.filter(event => {
                let date = new Date(event['dateTimeCet']);
                date.setHours(date.getHours() + 2);
                return date < TODAY;
            }).sort((e1, e2) => e1['dateTimeCet'] === e2['dateTimeCet'] ? e1['country'] < e2['country'] : e1['dateTimeCet'] < e2['dateTimeCet']);

            FUTURE_EVENTS = data.filter(event => {
                let date = new Date(event['dateTimeCet']);
                date.setHours(date.getHours() + 2);
                return date >= TODAY;
            });

            let lastMonth = "";
            FUTURE_EVENTS.forEach((event) => {
                const date = new Date(event['dateTimeCet']);
                const month = date.toLocaleString('en-GB', { month: 'long' });
                if (month != lastMonth) {
                    lastMonth = month;
                    addMonthLabel(month, true);
                }
                addEvent(event, date, true);
            });
            enableWatchLinks(true);

            if (PAST_EVENTS.length > 0) {
                $("#show-past-events").css("display", "flex");
            }
        });

        $("#show-past-events").click(function() {
            $("#show-past-events").css("display", "none");
            $(".month-label:first").remove();
            let lastMonth = new Date(FUTURE_EVENTS[0]['dateTimeCet']).toLocaleString('en-GB', { month: 'long' });
            PAST_EVENTS.forEach((event) => {
                const date = new Date(event['dateTimeCet']);
                const month = date.toLocaleString('en-GB', { month: 'long' });
                if (month != lastMonth) {
                    addMonthLabel(lastMonth, false);
                    lastMonth = month;
                }
                addEvent(event, date, false);
            });
            addMonthLabel(new Date(PAST_EVENTS[PAST_EVENTS.length - 1]['dateTimeCet']).toLocaleString('en-GB', { month: 'long' }), false);
            enableWatchLinks(false);
        });
    })
</script>
<meta content="width=device-width, initial-scale=1" name="viewport" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="style.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/icon?family=Material+Icons|Material+Icons+Outlined" rel="stylesheet">
<title>Lys</title>
<body class="dark-mode">
    <div class="nav">
        <a href="./help.html">Help</a> Â·
        <a href="https://twitter.com/eurovisionlys/">Twitter</a>
    </div>
    <div class="header">
        <div class="logo">Lys</div>
        <div class="toggle">
            <label class="pure-material-switch">
                <input type="checkbox" id="dark-mode-toggle" checked>
                <span><i class="material-icons-outlined">dark_mode</i></span>
            </label>
        </div>
    </div>
    <div class="legend">
        <div class="title"><a href="#!" id="legend-toggle">Legend <i class="material-icons">expand_less</i></a></div>
        <ul>
            <li><i class="material-icons">public_off</i> Geoblocked</li>
            <li><i class="material-icons">person</i> Account required</li>
            <li><i class="material-icons">replay</i> Replayable</li>
            <li><i class="material-icons">cast</i> Castable</li>
        </ul>
    </div>
    <a href="#!" id="show-past-events" style="display: none">
        <i class="material-icons-outlined">arrow_upward</i>
        <span>Show past</span>
    </a>
    <div id="calendar">
    </div>
</body>